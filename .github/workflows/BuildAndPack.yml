name: BuildAndPack
on:
    push:
        branches: [main]
        tags: ['*']
    pull_request:

jobs:
    build-and-publish:
        permissions: 
            contents: read
            id-token: write
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-dotnet@v4
              with:
                dotnet-version: 10.0.x

            - name: dotnet pack
              run: |
                dotnet pack -r
            
            - name: NuGet login (OIDC â†’ temp API key)
              uses: NuGet/login@v1
              id: login
              with:
                # Secret is your NuGet username, e.g. andrewlock
                user: ${{ secrets.NUGET_USER }}

            - name: push to NuGet
              shell: pwsh
              # Loop through all the packages in the output folder and push them to
              # nuget.org, using the NUGET_API_KEY generated by the previous login step
              run: |
                Get-ChildItem artifacts/package/release -Filter *.nupkg | ForEach-Object {
                    dotnet nuget push $_.FullName `
                    --api-key "${{ steps.login.outputs.NUGET_API_KEY }}" `
                    --source https://api.nuget.org/v3/index.json
                }